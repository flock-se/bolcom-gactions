const chai = require('chai');
const expect = chai.expect;
const testResponse = require('./testResponse');

describe('Welcome state', function() {
  describe('Buy intent', function() {
    this.timeout(3000);
    const payload = {"originalRequest":{"source":"google","version":"2","data":{"isInSandbox":true,"surface":{"capabilities":[{"name":"actions.capability.SCREEN_OUTPUT"},{"name":"actions.capability.AUDIO_OUTPUT"},{"name":"actions.capability.WEB_BROWSER"},{"name":"actions.capability.MEDIA_RESPONSE_AUDIO"}]},"inputs":[{"rawInputs":[{"query":"I would like to buy The Lord of the Rings","inputType":"VOICE"}],"arguments":[{"rawText":"I would like to buy The Lord of the Rings","textValue":"I would like to buy The Lord of the Rings","name":"text"}],"intent":"actions.intent.TEXT"}],"user":{"userStorage":"{\"data\":{}}","lastSeen":"2018-02-02T09:38:48Z","locale":"en-US","userId":"ABwppHEr0uNI6-_PRusnyf3N9q-e7SYMRMD7U8hl5dUgFXofIz6YxFhFApRiwq3DlFwdTrm232qYwllsNA"},"conversation":{"conversationId":"1517564726799","type":"ACTIVE","conversationToken":"[]"},"availableSurfaces":[{"capabilities":[{"name":"actions.capability.SCREEN_OUTPUT"},{"name":"actions.capability.AUDIO_OUTPUT"}]}]}},"id":"d2240db8-1110-46e8-8b71-ce4c19d30c03","timestamp":"2018-02-02T09:46:33.71Z","lang":"en-us","result":{"source":"agent","resolvedQuery":"I would like to buy The Lord of the Rings","speech":"","action":"DefaultWelcomeIntent.DefaultWelcomeIntent-custom","actionIncomplete":false,"parameters":{"BookType":"","BookTitle":"The Lord of the Rings","date-period":""},"contexts":[{"name":"actions_capability_screen_output","parameters":{"BookType.original":"","BookType":"","date-period.original":"","BookTitle":"The Lord of the Rings","date-period":"","BookTitle.original":"The Lord of the Rings"},"lifespan":0},{"name":"buyintent-followup","parameters":{"BookType.original":"","BookType":"","date-period.original":"","BookTitle":"The Lord of the Rings","date-period":"","BookTitle.original":"The Lord of the Rings"},"lifespan":2},{"name":"actions_capability_audio_output","parameters":{"BookType.original":"","BookType":"","date-period.original":"","BookTitle":"The Lord of the Rings","date-period":"","BookTitle.original":"The Lord of the Rings"},"lifespan":0},{"name":"google_assistant_input_type_voice","parameters":{"BookType.original":"","BookType":"","date-period.original":"","BookTitle":"The Lord of the Rings","date-period":"","BookTitle.original":"The Lord of the Rings"},"lifespan":0},{"name":"actions_capability_media_response_audio","parameters":{"BookType.original":"","BookType":"","date-period.original":"","BookTitle":"The Lord of the Rings","date-period":"","BookTitle.original":"The Lord of the Rings"},"lifespan":0},{"name":"actions_capability_web_browser","parameters":{"BookType.original":"","BookType":"","date-period.original":"","BookTitle":"The Lord of the Rings","date-period":"","BookTitle.original":"The Lord of the Rings"},"lifespan":0}],"metadata":{"matchedParameters":[{"required":true,"dataType":"@BookTitle","name":"BookTitle","value":"$BookTitle","isList":false}],"intentName":"Buy intent","intentId":"819a1eec-dde6-4ed0-9a06-4b42bd9c400b","webhookUsed":"true","webhookForSlotFillingUsed":"false","nluResponseTime":249},"fulfillment":{"speech":"Are you sure you want to buy The Lord of the Rings?","messages":[{"type":"simple_response","platform":"google","textToSpeech":"Are you sure you want to buy The Lord of the Rings?"},{"type":0,"speech":"Are you sure you want to buy The Lord of the Rings?"}]},"score":1},"status":{"code":200,"errorType":"success","webhookTimedOut":false},"sessionId":"1517564726799"};
    it('lists the number of found results and the first result', function() {
      return testResponse(payload, function(data) {
        expect(data.body.speech).to.match(/^Found \d+ books for The Lord of the Rings\. The first one is The Lord of the Rings Boxset by J\.R\.R\. Tolkien\.$/)
      })
    });
  });
});